<!DOCTYPE html>
<html lang="en">
    <head>
    <title>Using rust&#x27;s target runner for iOS simulators - Sebastian Imlay</title>
    
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1"><meta name="description" content="The home of simlay.net Using rust&#x27;s target runner for iOS simulators This is an example of using cargo run for iOS simulator targets"/>
    <meta property="og:title" content="simlay -&nbsp;Using rust&#x27;s target runner for iOS simulators" />
    <meta property="og:type" content="website"/><meta property="og:url" content="https:&#x2F;&#x2F;simlay.net&#x2F;posts&#x2F;rust-target-runner-for-ios&#x2F;"/><meta property="og:description" content="This is an example of using cargo run for iOS simulator targets"/><meta property="og:image" content="https://simlay.net/simlay.png"/>
    <link rel="preload" href="https://simlay.net/assets/fonts/FiraCode-Regular.woff2" as="font" type="font/woff2" crossorigin="anonymous">
    <link rel="preload" href="https://simlay.net/assets/fonts/FiraCode-Bold.woff2" as="font" type="font/woff2" crossorigin="anonymous">

    <link rel="stylesheet" href="https://simlay.net/style.css?h=97e262212a0704163528">
    <link rel="stylesheet" href="https://simlay.net/color/blue.css?h=43198b832df0f2b5f2cf">
<!-- Google Analytics -->
        <script async src="https://www.googletagmanager.com/gtag/js?id=UA-44653605-1"></script>
        <script>
            window.dataLayer = window.dataLayer || [];
            function gtag(){dataLayer.push(arguments);}
            gtag('js', new Date());
            gtag('config', 'UA-44653605-1');
        </script>
    </head>
    <body>
        <div class="container">
<header class="header">
    <div class="header__inner">
        <div class="header__logo">
            <a href="https:&#x2F;&#x2F;simlay.net">
    <div class="logo">
        simlay
    </div>
</a>
        </div>
        <div class="menu-trigger">menu</div>
    </div>
    
    <nav class="menu">
        <ul class="menu__inner menu__inner--desktop">
            
            
        <li>
            <a href="
    
        https://simlay.net/me
    
">me</a>
        </li></ul>

        <ul class="menu__inner menu__inner--mobile">
            
        <li>
            <a href="
    
        https://simlay.net/me
    
">me</a>
        </li>
        </ul>
    </nav>

    </header>
<div class="content"><article class="post">
        <header>
            <h1 class="post-title">
                <a href="https:&#x2F;&#x2F;simlay.net&#x2F;posts&#x2F;rust-target-runner-for-ios&#x2F;">Using rust&#x27;s target runner for iOS simulators</a>
            </h1>
            
    <div class="post-meta">
        <span class="post-date">2023.04.03
                </span>

        <span class="post-author"></span>

        

    
    </div>

            
    
</header><h1 id="introduction">Introduction<a class="zola-anchor" href="#introduction" aria-label="Anchor link for: introduction">ยง</a>
</h1>
<p>I've become a pretty big fan for rust and cargo. I've found it quite convenient
to run <code>cargo run</code> or <code>cargo test</code>. This doesn't work quite as nicely if you're
cross compiling. Fortunately, there's the <a href="https://doc.rust-lang.org/cargo/reference/config.html#targettriplerunner"><code>target.&lt;tripple&gt;.runner</code> cargo
feature</a>.
Unfortunately, I've found it hard to find example uses of this. An <a href="https://github.com/search?p=3&amp;q=runner+%3D+language%3ATOML+filename%3Aconfig.toml&amp;type=Code">advanced
search on GitHub for <code>runner = </code> in
<code>config.toml</code></a>
is how I've found other examples.</p>
<p>In this post, I demonstrate an iOS simulator target runner script. The way the
app's <code>Info.plist</code> is setup is liable to change and break in the future but
this works with <code>macOS 13.3</code>, <code>Xcode 14.1</code> targeted at the <code>iOS 16.1</code>
simulator.</p>
<p>The source code for this post is available in the <a href="https://github.com/simlay/simlay.github.io/tree/master/code"><code>code</code> subdirectory of this repo</a> if you want to use it.</p>
<h1 id="prior-work">Prior work<a class="zola-anchor" href="#prior-work" aria-label="Anchor link for: prior-work">ยง</a>
</h1>
<p>I discovered <a href="https://github.com/sonos/dinghy"><code>cargo dinghy</code></a> a few years ago
and <a href="https://github.com/sonos/dinghy/pull/96">added support for iOS simulator tests in
CI</a>. My complaints about using dinghy
here are:</p>
<ul>
<li>CI compiling dinghy (if you don't have it cached) and then compiling the
project. I've found this to result in longer CI times.</li>
<li>Recalling the arguments to dinghy such as <code>cargo dinghy --platform auto-ios-aarch64-sim test</code></li>
</ul>
<h1 id="setup">Setup<a class="zola-anchor" href="#setup" aria-label="Anchor link for: setup">ยง</a>
</h1>
<p>To get started, you need to specify the <a href="https://doc.rust-lang.org/cargo/reference/config.html#targettriplerunner">target runner for
cargo</a></p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span>[target.aarch64-apple-ios-sim]
</span><span>runner = &quot;</span><span style="color:#a3be8c;">./ios-sim-runner.sh</span><span>&quot;
</span><span>[target.x86_64-apple-ios]
</span><span>runner = &quot;</span><span style="color:#a3be8c;">./ios-sim-runner.sh</span><span>&quot;
</span></code></pre>
<p>This <a href="https://doc.rust-lang.org/cargo/reference/config.html#hierarchical-structure">cargo
config</a>
tells cargo what script/executable to use when running <code>cargo run --target aarch64-apple-ios-sim -- arg1 arg2</code>. The arguments to this script/executable
are the path to the target binary and then the arguments to said binary.</p>
<p>Here's the <code>ios-sim-runner.sh</code> script.</p>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#65737e;">#!/bin/sh
</span><span style="color:#96b5b4;">set </span><span style="color:#bf616a;">-o</span><span> pipefail
</span><span>
</span><span style="color:#bf616a;">EXECUTABLE</span><span>=$</span><span style="color:#bf616a;">1
</span><span style="color:#bf616a;">ARGS</span><span>=$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">@</span><span>:</span><span style="color:#d08770;">2</span><span style="color:#a3be8c;">}
</span><span>
</span><span style="color:#bf616a;">IDENTIFIER</span><span>=&quot;</span><span style="color:#a3be8c;">com.simlay.net.RustRunner</span><span>&quot;
</span><span style="color:#bf616a;">DISPLAY_NAME</span><span>=&quot;</span><span style="color:#a3be8c;">RustRunner</span><span>&quot;
</span><span style="color:#bf616a;">BUNDLE_NAME</span><span>=$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">DISPLAY_NAME</span><span style="color:#a3be8c;">}.App
</span><span style="color:#bf616a;">EXECUTABLE_NAME</span><span>=$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">basename </span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">EXECUTABLE</span><span style="color:#a3be8c;">})
</span><span style="color:#bf616a;">BUNDLE_PATH</span><span>=$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">dirname </span><span>$</span><span style="color:#bf616a;">EXECUTABLE</span><span style="color:#a3be8c;">)/</span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">BUNDLE_NAME</span><span style="color:#a3be8c;">}
</span><span>
</span><span style="color:#bf616a;">PLIST</span><span>=&quot;</span><span style="color:#a3be8c;">&lt;?xml version=</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">1.0</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;"> encoding=</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">UTF-8</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">?&gt;
</span><span style="color:#a3be8c;">    &lt;!DOCTYPE plist PUBLIC </span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">-//Apple Computer//DTD PLIST 1.0//EN</span><span style="color:#96b5b4;">\&quot;
</span><span style="color:#a3be8c;">    </span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">http://www.apple.com/DTDs/PropertyList-1.0.dtd</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">&gt;
</span><span style="color:#a3be8c;">    &lt;plist version=</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">1.0</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">&gt;
</span><span style="color:#a3be8c;">    &lt;dict&gt;
</span><span style="color:#a3be8c;">    &lt;key&gt;CFBundleIdentifier&lt;/key&gt;
</span><span style="color:#a3be8c;">    &lt;string&gt;</span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">IDENTIFIER</span><span style="color:#a3be8c;">}&lt;/string&gt;
</span><span style="color:#a3be8c;">    &lt;key&gt;CFBundleDisplayName&lt;/key&gt;
</span><span style="color:#a3be8c;">    &lt;string&gt;</span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">DISPLAY_NAME</span><span style="color:#a3be8c;">}&lt;/string&gt;
</span><span style="color:#a3be8c;">    &lt;key&gt;CFBundleName&lt;/key&gt;
</span><span style="color:#a3be8c;">    &lt;string&gt;</span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">BUNDLE_NAME</span><span style="color:#a3be8c;">}&lt;/string&gt;
</span><span style="color:#a3be8c;">    &lt;key&gt;CFBundleExecutable&lt;/key&gt;
</span><span style="color:#a3be8c;">    &lt;string&gt;</span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">EXECUTABLE_NAME</span><span style="color:#a3be8c;">}&lt;/string&gt;
</span><span style="color:#a3be8c;">    &lt;key&gt;CFBundleVersion&lt;/key&gt;
</span><span style="color:#a3be8c;">    &lt;string&gt;0.0.1&lt;/string&gt;
</span><span style="color:#a3be8c;">    &lt;key&gt;CFBundleShortVersionString&lt;/key&gt;
</span><span style="color:#a3be8c;">    &lt;string&gt;0.0.1&lt;/string&gt;
</span><span style="color:#a3be8c;">    &lt;key&gt;CFBundleDevelopmentRegion&lt;/key&gt;
</span><span style="color:#a3be8c;">    &lt;string&gt;en_US&lt;/string&gt;
</span><span style="color:#a3be8c;">    &lt;key&gt;UILaunchStoryboardName&lt;/key&gt;
</span><span style="color:#a3be8c;">    &lt;string&gt;&lt;/string&gt;
</span><span style="color:#a3be8c;">    &lt;key&gt;CFBundleIconFiles&lt;/key&gt;
</span><span style="color:#a3be8c;">    &lt;array&gt;
</span><span style="color:#a3be8c;">    &lt;/array&gt;
</span><span style="color:#a3be8c;">    &lt;key&gt;LSRequiresIPhoneOS&lt;/key&gt;
</span><span style="color:#a3be8c;">    &lt;true/&gt;
</span><span style="color:#a3be8c;">    &lt;/dict&gt;
</span><span style="color:#a3be8c;">&lt;/plist&gt;</span><span>&quot;
</span><span>
</span><span style="color:#bf616a;">rm -rf </span><span>&quot;$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">BUNDLE_PATH</span><span style="color:#a3be8c;">}</span><span>&quot; </span><span style="color:#d08770;">2</span><span>&gt; /dev/null
</span><span style="color:#bf616a;">mkdir -p </span><span>${</span><span style="color:#bf616a;">BUNDLE_PATH</span><span>}
</span><span>
</span><span style="color:#96b5b4;">echo </span><span>$</span><span style="color:#bf616a;">PLIST </span><span>&gt; ${</span><span style="color:#bf616a;">BUNDLE_PATH</span><span>}/Info.plist
</span><span style="color:#bf616a;">cp </span><span>${</span><span style="color:#bf616a;">EXECUTABLE</span><span>} ${</span><span style="color:#bf616a;">BUNDLE_PATH</span><span>}
</span><span>
</span><span style="color:#65737e;"># Some simctl helper functions
</span><span style="color:#8fa1b3;">ios_runtime</span><span>() {
</span><span>    </span><span style="color:#bf616a;">xcrun</span><span> simctl list</span><span style="color:#bf616a;"> -j</span><span> runtimes ios | \
</span><span>        </span><span style="color:#bf616a;">jq -r </span><span>&#39;</span><span style="color:#a3be8c;">.[] | sort_by(.identifier)[0].identifier</span><span>&#39;
</span><span>}
</span><span style="color:#8fa1b3;">ios_devices</span><span>() {
</span><span>    </span><span style="color:#bf616a;">xcrun</span><span> simctl list</span><span style="color:#bf616a;"> -j</span><span> devices ios | \
</span><span>        </span><span style="color:#bf616a;">jq </span><span>&quot;</span><span style="color:#a3be8c;">.devices.</span><span style="color:#96b5b4;">\&quot;</span><span>$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">ios_runtime</span><span style="color:#a3be8c;">)</span><span style="color:#96b5b4;">\&quot;</span><span>&quot; | </span><span style="color:#bf616a;">jq </span><span>&#39;</span><span style="color:#a3be8c;">sort_by(.deviceTypeIdentifier)</span><span>&#39;
</span><span>}
</span><span>
</span><span style="color:#8fa1b3;">ios_devices_booted</span><span>() {
</span><span>    </span><span style="color:#bf616a;">ios_devices </span><span>| </span><span style="color:#bf616a;">jq </span><span>&#39;</span><span style="color:#a3be8c;">[.[] | select(.state == &quot;Booted&quot;)]</span><span>&#39;
</span><span>}
</span><span>
</span><span style="color:#8fa1b3;">ios_devices_shutdown</span><span>() {
</span><span>    </span><span style="color:#bf616a;">ios_devices </span><span>| </span><span style="color:#bf616a;">jq </span><span>&#39;</span><span style="color:#a3be8c;">[.[] | select(.state == &quot;Shutdown&quot;)]</span><span>&#39;
</span><span>}
</span><span>
</span><span style="color:#8fa1b3;">ios_devices_get_id</span><span>() {
</span><span>    </span><span style="color:#bf616a;">booted</span><span>=$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">ios_devices_booted</span><span style="color:#a3be8c;">)
</span><span>    </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">[ </span><span>&quot;$</span><span style="color:#bf616a;">booted</span><span>&quot; != &quot;</span><span style="color:#a3be8c;">[]</span><span>&quot; </span><span style="color:#96b5b4;">]</span><span>; </span><span style="color:#b48ead;">then
</span><span>        </span><span style="color:#96b5b4;">echo </span><span>$</span><span style="color:#bf616a;">booted </span><span>| </span><span style="color:#bf616a;">jq -r </span><span>&#39;</span><span style="color:#a3be8c;">.[0].udid</span><span>&#39;
</span><span>    </span><span style="color:#b48ead;">else
</span><span>        </span><span style="color:#bf616a;">device_id</span><span>=$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">ios_devices_shutdown </span><span>| </span><span style="color:#bf616a;">jq -r </span><span>&#39;</span><span style="color:#a3be8c;">.[0].udid</span><span>&#39;</span><span style="color:#a3be8c;">)
</span><span>        </span><span style="color:#bf616a;">xcrun</span><span> simctl boot $</span><span style="color:#bf616a;">device_id
</span><span>        </span><span style="color:#96b5b4;">echo </span><span>$</span><span style="color:#bf616a;">device_id
</span><span>    </span><span style="color:#b48ead;">fi
</span><span>}
</span><span style="color:#bf616a;">DEVICE_ID</span><span>=$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">ios_devices_get_id</span><span style="color:#a3be8c;">)
</span><span>
</span><span style="color:#65737e;"># Install/reinstall the app, Start the app in the iOS simulator but wait for
</span><span style="color:#65737e;"># the debugger to attach
</span><span style="color:#bf616a;">xcrun</span><span> simctl uninstall ${</span><span style="color:#bf616a;">DEVICE_ID</span><span>} ${</span><span style="color:#bf616a;">IDENTIFIER</span><span>}
</span><span style="color:#bf616a;">xcrun</span><span> simctl install ${</span><span style="color:#bf616a;">DEVICE_ID</span><span>} ${</span><span style="color:#bf616a;">BUNDLE_PATH</span><span>}
</span><span style="color:#bf616a;">INSTALLED_PATH</span><span>=$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">xcrun</span><span style="color:#a3be8c;"> simctl get_app_container </span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">DEVICE_ID</span><span style="color:#a3be8c;">} </span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">IDENTIFIER</span><span style="color:#a3be8c;">})
</span><span style="color:#bf616a;">APP_STDOUT</span><span>=$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">INSTALLED_PATH</span><span style="color:#a3be8c;">}/stdout
</span><span style="color:#bf616a;">APP_STDERR</span><span>=$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">INSTALLED_PATH</span><span style="color:#a3be8c;">}/stderr
</span><span>
</span><span style="color:#bf616a;">APP_PID</span><span>=$</span><span style="color:#a3be8c;">(\
</span><span style="color:#a3be8c;">    </span><span style="color:#bf616a;">xcrun</span><span style="color:#a3be8c;"> simctl launch</span><span style="color:#bf616a;"> -w </span><span style="color:#a3be8c;">\
</span><span style="color:#bf616a;">    --stdout</span><span>=$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">APP_STDOUT</span><span style="color:#a3be8c;">} \
</span><span style="color:#bf616a;">    --stderr</span><span>=$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">APP_STDERR</span><span style="color:#a3be8c;">} \
</span><span style="color:#bf616a;">    --terminate-running-process </span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">DEVICE_ID</span><span style="color:#a3be8c;">} </span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">IDENTIFIER</span><span style="color:#a3be8c;">} </span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">ARGS</span><span style="color:#a3be8c;">} \
</span><span style="color:#a3be8c;">    </span><span>| </span><span style="color:#bf616a;">awk -F</span><span style="color:#a3be8c;">: </span><span>&#39;</span><span style="color:#a3be8c;">{print $2}</span><span>&#39;</span><span style="color:#a3be8c;">)
</span><span>
</span><span style="color:#65737e;"># Attach to the app using lldb.
</span><span style="color:#bf616a;">LLDB_SCRIPT_FILE</span><span>=$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">mktemp</span><span style="color:#a3be8c;"> /tmp/lldb_script.XXXXX)
</span><span style="color:#96b5b4;">echo </span><span>&quot;</span><span style="color:#a3be8c;">attach </span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">APP_PID</span><span style="color:#a3be8c;">}</span><span>&quot; &gt;&gt; ${</span><span style="color:#bf616a;">LLDB_SCRIPT_FILE</span><span>}
</span><span style="color:#96b5b4;">echo </span><span>&quot;</span><span style="color:#a3be8c;">continue</span><span>&quot; &gt;&gt; ${</span><span style="color:#bf616a;">LLDB_SCRIPT_FILE</span><span>}
</span><span style="color:#96b5b4;">echo </span><span>&quot;</span><span style="color:#a3be8c;">quit</span><span>&quot; &gt;&gt; ${</span><span style="color:#bf616a;">LLDB_SCRIPT_FILE</span><span>}
</span><span>
</span><span style="color:#bf616a;">LLDB_OUT_FILE</span><span>=$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">mktemp</span><span style="color:#a3be8c;"> /tmp/lldb_script.XXXXX)
</span><span style="color:#bf616a;">lldb -s </span><span>${</span><span style="color:#bf616a;">LLDB_SCRIPT_FILE</span><span>} &gt; ${</span><span style="color:#bf616a;">LLDB_OUT_FILE</span><span>}
</span><span>
</span><span style="color:#65737e;"># This is the stdout LLDB:
</span><span style="color:#65737e;">#
</span><span style="color:#65737e;"># (lldb) command source -s 0 &#39;/tmp/lldb.xijJI&#39;
</span><span style="color:#65737e;"># Executing commands in &#39;/tmp/lldb.xijJI&#39;.
</span><span style="color:#65737e;"># (lldb) attach  89772
</span><span style="color:#65737e;"># Process 89772 stopped
</span><span style="color:#65737e;"># * thread #1, stop reason = signal SIGSTOP
</span><span style="color:#65737e;">#     frame #0: 0x0000000102b00a40 dyld`_dyld_start
</span><span style="color:#65737e;"># dyld`:
</span><span style="color:#65737e;"># -&gt;  0x102b00a40 &lt;+0&gt;:  mov    x0, sp
</span><span style="color:#65737e;">#     0x102b00a44 &lt;+4&gt;:  and    sp, x0, #0xfffffffffffffff0
</span><span style="color:#65737e;">#     0x102b00a48 &lt;+8&gt;:  mov    x29, #0x0
</span><span style="color:#65737e;">#     0x102b00a4c &lt;+12&gt;: mov    x30, #0x0
</span><span style="color:#65737e;"># Target 0: (test_runner-8652616abdef98d9) stopped.
</span><span style="color:#65737e;"># Executable module set to &quot;THE PATH TO THE IOS BUNDLED APP IN THE APP&quot;.
</span><span style="color:#65737e;"># Architecture set to: arm64e-apple-ios-simulator.
</span><span style="color:#65737e;"># (lldb) continue
</span><span style="color:#65737e;"># Process 89772 resuming
</span><span style="color:#65737e;"># Process 89772 exited with status = 0 (0x00000000)
</span><span style="color:#65737e;"># (lldb) quit
</span><span>
</span><span>
</span><span style="color:#65737e;"># Parse the output of lldb to retrieve the status code.
</span><span style="color:#bf616a;">STATUS_CODE</span><span>=$</span><span style="color:#a3be8c;">(\
</span><span style="color:#a3be8c;">    </span><span style="color:#bf616a;">cat </span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">LLDB_OUT_FILE</span><span style="color:#a3be8c;">} </span><span>| </span><span style="color:#a3be8c;">\
</span><span style="color:#a3be8c;">    </span><span style="color:#bf616a;">grep </span><span>&quot;</span><span style="color:#a3be8c;">Process \d\+ exited with status = \d\+</span><span>&quot; | </span><span style="color:#a3be8c;">\
</span><span style="color:#a3be8c;">    </span><span style="color:#bf616a;">grep </span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">APP_PID</span><span style="color:#a3be8c;">} </span><span>| </span><span style="color:#a3be8c;">\
</span><span style="color:#a3be8c;">    </span><span style="color:#bf616a;">grep -o </span><span>&quot;</span><span style="color:#a3be8c;">= \d\+</span><span>&quot; | </span><span style="color:#a3be8c;">\
</span><span style="color:#a3be8c;">    </span><span style="color:#bf616a;">sed </span><span>&#39;</span><span style="color:#a3be8c;">s/= //g</span><span>&#39;</span><span style="color:#a3be8c;">\
</span><span style="color:#a3be8c;">)
</span><span style="color:#bf616a;">cat </span><span>${</span><span style="color:#bf616a;">APP_STDOUT</span><span>}
</span><span style="color:#bf616a;">cat </span><span>${</span><span style="color:#bf616a;">APP_STDERR</span><span>} &gt;&amp;</span><span style="color:#d08770;">2
</span><span>
</span><span style="color:#96b5b4;">exit </span><span>${</span><span style="color:#bf616a;">STATUS_CODE</span><span>}
</span></code></pre>
<h1 id="usage">Usage<a class="zola-anchor" href="#usage" aria-label="Anchor link for: usage">ยง</a>
</h1>
<p>With a simple rust <code>main.rs</code> or <code>lib.rs</code>:</p>
<pre data-lang="rust" style="background-color:#2b303b;color:#c0c5ce;" class="language-rust "><code class="language-rust" data-lang="rust"><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">main</span><span>() {
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">Hello world args - </span><span style="color:#d08770;">{:?}</span><span>&quot;, std::env::args());
</span><span>    </span><span style="color:#b48ead;">let</span><span> first = </span><span style="color:#d08770;">2</span><span>;
</span><span>    </span><span style="color:#b48ead;">let</span><span> second = </span><span style="color:#d08770;">3</span><span>;
</span><span>    println!(&quot;</span><span style="color:#a3be8c;">add </span><span style="color:#d08770;">{}</span><span style="color:#a3be8c;"> + </span><span style="color:#d08770;">{}</span><span style="color:#a3be8c;"> = </span><span style="color:#d08770;">{}</span><span>&quot;, first, second, </span><span style="color:#96b5b4;">add</span><span>(first, second));
</span><span>}
</span><span>
</span><span style="color:#b48ead;">pub fn </span><span style="color:#8fa1b3;">add</span><span>(</span><span style="color:#bf616a;">left</span><span>: </span><span style="color:#b48ead;">usize</span><span>, </span><span style="color:#bf616a;">right</span><span>: </span><span style="color:#b48ead;">usize</span><span>) -&gt; </span><span style="color:#b48ead;">usize </span><span>{
</span><span>    left + right
</span><span>}
</span><span>
</span><span>#[</span><span style="color:#bf616a;">cfg</span><span>(test)]
</span><span style="color:#b48ead;">mod </span><span>tests {
</span><span>    </span><span style="color:#b48ead;">use super</span><span>::*;
</span><span>
</span><span>    #[</span><span style="color:#bf616a;">test</span><span>]
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">this_test_passes</span><span>() {
</span><span>        </span><span style="color:#b48ead;">let</span><span> result = </span><span style="color:#96b5b4;">add</span><span>(</span><span style="color:#d08770;">2</span><span>, </span><span style="color:#d08770;">2</span><span>);
</span><span>        assert_eq!(result, </span><span style="color:#d08770;">4</span><span>);
</span><span>    }
</span><span>
</span><span>    #[</span><span style="color:#bf616a;">test</span><span>]
</span><span>    </span><span style="color:#b48ead;">fn </span><span style="color:#8fa1b3;">this_test_fails</span><span>() {
</span><span>        </span><span style="color:#b48ead;">let</span><span> result = </span><span style="color:#96b5b4;">add</span><span>(</span><span style="color:#d08770;">2</span><span>, </span><span style="color:#d08770;">2</span><span>);
</span><span>        assert_eq!(result, </span><span style="color:#d08770;">5</span><span>);
</span><span>    }
</span><span>}
</span></code></pre>
<p>Put the <code>ios-sim-runner.sh</code> in your path or local to the project and the
<code>.cargo/config.toml</code> in desired cargo configuration and then you'll be able to
run:</p>
<p><code>cargo test --target x86_64-apple-ios</code> or <code>cargo test --target aarch64-apple-ios-sim</code> and you'll see something like the following:</p>
<pre style="background-color:#2b303b;color:#c0c5ce;"><code><span>    Finished test [unoptimized + debuginfo] target(s) in 0.00s
</span><span>     Running unittests src/main.rs (target/aarch64-apple-ios-sim/debug/deps/rust_target_runner_for_ios-21a08454287c0bcd)
</span><span>
</span><span>running 2 tests
</span><span>test tests::this_test_passes ... ok
</span><span>test tests::this_test_fails ... FAILED
</span><span>
</span><span>failures:
</span><span>
</span><span>---- tests::this_test_fails stdout ----
</span><span>thread &#39;tests::this_test_fails&#39; panicked at &#39;assertion failed: `(left == right)`
</span><span>  left: `4`,
</span><span> right: `5`&#39;, src/main.rs:26:9
</span><span>note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace
</span><span>
</span><span>
</span><span>failures:
</span><span>    tests::this_test_fails
</span><span>
</span><span>test result: FAILED. 1 passed; 1 failed; 0 ignored; 0 measured; 0 filtered out; finished in 0.00s
</span><span>
</span><span>error: test failed, to rerun pass `--bin rust-target-runner-for-ios`
</span></code></pre>
<p>One can do <code>cargo test --target aarch64-apple-ios-sim -- this_test_passes</code> or
<code>cargo run --target aarch64-apple-ios-sim</code></p>
<h1 id="description">Description<a class="zola-anchor" href="#description" aria-label="Anchor link for: description">ยง</a>
</h1>
<p>Given that this script will certainly break in the future due to changes with
either <code>simctl</code> or the <code>Info.plist</code> specifications so I'll tell you about the
sections.</p>
<h2 id="app-bundle">App Bundle<a class="zola-anchor" href="#app-bundle" aria-label="Anchor link for: app-bundle">ยง</a>
</h2>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">IDENTIFIER</span><span>=&quot;</span><span style="color:#a3be8c;">com.simlay.net.RustRunner</span><span>&quot;</span><span style="color:#bf616a;">DISPLAY_NAME</span><span>=&quot;</span><span style="color:#a3be8c;">RustRunner</span><span>&quot;</span><span style="color:#bf616a;">BUNDLE_NAME</span><span>=$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">DISPLAY_NAME</span><span style="color:#a3be8c;">}.App</span><span style="color:#bf616a;">EXECUTABLE_NAME</span><span>=$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">basename </span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">EXECUTABLE</span><span style="color:#a3be8c;">})</span><span style="color:#bf616a;">BUNDLE_PATH</span><span>=$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">dirname </span><span>$</span><span style="color:#bf616a;">EXECUTABLE</span><span style="color:#a3be8c;">)/</span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">BUNDLE_NAME</span><span style="color:#a3be8c;">}</span><span style="color:#bf616a;">PLIST</span><span>=&quot;</span><span style="color:#a3be8c;">&lt;?xml version=</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">1.0</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;"> encoding=</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">UTF-8</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">?&gt;    &lt;!DOCTYPE plist PUBLIC </span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">-//Apple Computer//DTD PLIST 1.0//EN</span><span style="color:#96b5b4;">\&quot;    \&quot;</span><span style="color:#a3be8c;">http://www.apple.com/DTDs/PropertyList-1.0.dtd</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">&gt;    &lt;plist version=</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">1.0</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">&gt;    &lt;dict&gt;    &lt;key&gt;CFBundleIdentifier&lt;/key&gt;    &lt;string&gt;</span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">IDENTIFIER</span><span style="color:#a3be8c;">}&lt;/string&gt;    &lt;key&gt;CFBundleDisplayName&lt;/key&gt;    &lt;string&gt;</span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">DISPLAY_NAME</span><span style="color:#a3be8c;">}&lt;/string&gt;    &lt;key&gt;CFBundleName&lt;/key&gt;    &lt;string&gt;</span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">BUNDLE_NAME</span><span style="color:#a3be8c;">}&lt;/string&gt;    &lt;key&gt;CFBundleExecutable&lt;/key&gt;    &lt;string&gt;</span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">EXECUTABLE_NAME</span><span style="color:#a3be8c;">}&lt;/string&gt;    &lt;key&gt;CFBundleVersion&lt;/key&gt;    &lt;string&gt;0.0.1&lt;/string&gt;    &lt;key&gt;CFBundleShortVersionString&lt;/key&gt;    &lt;string&gt;0.0.1&lt;/string&gt;    &lt;key&gt;CFBundleDevelopmentRegion&lt;/key&gt;    &lt;string&gt;en_US&lt;/string&gt;    &lt;key&gt;UILaunchStoryboardName&lt;/key&gt;    &lt;string&gt;&lt;/string&gt;    &lt;key&gt;CFBundleIconFiles&lt;/key&gt;    &lt;array&gt;    &lt;/array&gt;    &lt;key&gt;LSRequiresIPhoneOS&lt;/key&gt;    &lt;true/&gt;    &lt;/dict&gt;&lt;/plist&gt;</span><span>&quot;</span><span style="color:#bf616a;">rm -rf </span><span>&quot;$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">BUNDLE_PATH</span><span style="color:#a3be8c;">}</span><span>&quot; </span><span style="color:#d08770;">2</span><span>&gt; /dev/nullmkdir</span><span style="color:#bf616a;"> -p </span><span>${</span><span style="color:#bf616a;">BUNDLE_PATH</span><span>}echo $</span><span style="color:#bf616a;">PLIST </span><span>&gt; ${</span><span style="color:#bf616a;">BUNDLE_PATH</span><span>}/Info.plistcp ${</span><span style="color:#bf616a;">EXECUTABLE</span><span>} ${</span><span style="color:#bf616a;">BUNDLE_PATH</span><span>}
</span></code></pre>
<p>This is the section to bundle the executable that's the first argument into an
iOS simulator app.</p>
<h2 id="device-id">Device ID<a class="zola-anchor" href="#device-id" aria-label="Anchor link for: device-id">ยง</a>
</h2>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#8fa1b3;">ios_runtime</span><span>() {    </span><span style="color:#bf616a;">xcrun</span><span> simctl list</span><span style="color:#bf616a;"> -j</span><span> runtimes ios | </span><span style="color:#96b5b4;">\        </span><span style="color:#bf616a;">jq -r </span><span>&#39;</span><span style="color:#a3be8c;">.[] | sort_by(.identifier)[0].identifier</span><span>&#39;}</span><span style="color:#8fa1b3;">ios_devices</span><span>() {    </span><span style="color:#bf616a;">xcrun</span><span> simctl list</span><span style="color:#bf616a;"> -j</span><span> devices ios | </span><span style="color:#96b5b4;">\        </span><span style="color:#bf616a;">jq </span><span>&quot;</span><span style="color:#a3be8c;">.devices.</span><span style="color:#96b5b4;">\&quot;</span><span>$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">ios_runtime</span><span style="color:#a3be8c;">)</span><span style="color:#96b5b4;">\&quot;</span><span>&quot; | </span><span style="color:#bf616a;">jq </span><span>&#39;</span><span style="color:#a3be8c;">sort_by(.deviceTypeIdentifier)</span><span>&#39;}</span><span style="color:#8fa1b3;">ios_devices_booted</span><span>() {    </span><span style="color:#bf616a;">ios_devices </span><span>| </span><span style="color:#bf616a;">jq </span><span>&#39;</span><span style="color:#a3be8c;">[.[] | select(.state == &quot;Booted&quot;)]</span><span>&#39;}</span><span style="color:#8fa1b3;">ios_devices_shutdown</span><span>() {    </span><span style="color:#bf616a;">ios_devices </span><span>| </span><span style="color:#bf616a;">jq </span><span>&#39;</span><span style="color:#a3be8c;">[.[] | select(.state == &quot;Shutdown&quot;)]</span><span>&#39;}</span><span style="color:#8fa1b3;">ios_devices_get_id</span><span>() {    </span><span style="color:#bf616a;">booted</span><span>=$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">ios_devices_booted</span><span style="color:#a3be8c;">)    </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">[ </span><span>&quot;$</span><span style="color:#bf616a;">booted</span><span>&quot; != &quot;</span><span style="color:#a3be8c;">[]</span><span>&quot; </span><span style="color:#96b5b4;">]</span><span>; </span><span style="color:#b48ead;">then        </span><span style="color:#96b5b4;">echo </span><span>$</span><span style="color:#bf616a;">booted </span><span>| </span><span style="color:#bf616a;">jq -r </span><span>&#39;</span><span style="color:#a3be8c;">.[0].udid</span><span>&#39;    else        device_id=$(</span><span style="color:#bf616a;">ios_devices_shutdown </span><span>| </span><span style="color:#bf616a;">jq -r </span><span>&#39;</span><span style="color:#a3be8c;">.[0].udid</span><span>&#39;)        xcrun simctl boot $</span><span style="color:#bf616a;">device_id</span><span>        echo $</span><span style="color:#bf616a;">device_id</span><span>    fi}</span><span style="color:#bf616a;">DEVICE_ID</span><span>=$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">ios_devices_get_id</span><span style="color:#a3be8c;">)
</span></code></pre>
<p>This whole section is about getting the <code>DEVICE_ID</code> as this is needed for the
<code>get_app_container</code>. Otherwise, one can just use <code>booted</code> for most cases of
device id.</p>
<p>This will start an iOS simulator if one is not started.</p>
<h2 id="start-the-app">Start the app<a class="zola-anchor" href="#start-the-app" aria-label="Anchor link for: start-the-app">ยง</a>
</h2>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">xcrun</span><span> simctl uninstall ${</span><span style="color:#bf616a;">DEVICE_ID</span><span>} ${</span><span style="color:#bf616a;">IDENTIFIER</span><span>}xcrun simctl install ${</span><span style="color:#bf616a;">DEVICE_ID</span><span>} ${</span><span style="color:#bf616a;">BUNDLE_PATH</span><span>}INSTALLED_PATH=$(</span><span style="color:#bf616a;">xcrun</span><span> simctl get_app_container ${</span><span style="color:#bf616a;">DEVICE_ID</span><span>} ${</span><span style="color:#bf616a;">IDENTIFIER</span><span>})APP_STDOUT=${</span><span style="color:#bf616a;">INSTALLED_PATH</span><span>}/stdoutAPP_STDERR=${</span><span style="color:#bf616a;">INSTALLED_PATH</span><span>}/stderrAPP_PID=$(</span><span style="color:#96b5b4;">\    </span><span style="color:#bf616a;">xcrun</span><span> simctl launch</span><span style="color:#bf616a;"> -w </span><span style="color:#96b5b4;">\</span><span style="color:#bf616a;">    --stdout</span><span>=${</span><span style="color:#bf616a;">APP_STDOUT</span><span>} </span><span style="color:#96b5b4;">\</span><span style="color:#bf616a;">    --stderr</span><span>=${</span><span style="color:#bf616a;">APP_STDERR</span><span>} </span><span style="color:#96b5b4;">\</span><span style="color:#bf616a;">    --terminate-running-process </span><span>${</span><span style="color:#bf616a;">DEVICE_ID</span><span>} ${</span><span style="color:#bf616a;">IDENTIFIER</span><span>} ${</span><span style="color:#bf616a;">ARGS</span><span>} </span><span style="color:#96b5b4;">\    </span><span>| </span><span style="color:#bf616a;">awk -F</span><span>: &#39;</span><span style="color:#a3be8c;">{print $2}</span><span>&#39;)
</span></code></pre>
<p>Here we install the app bundle and start the app in waiting/debugger mode as
we'll later use the <code>PID</code> to retrieve the exit status of the app and propagate
the status code up.</p>
<h2 id="lldb">LLDB<a class="zola-anchor" href="#lldb" aria-label="Anchor link for: lldb">ยง</a>
</h2>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">LLDB_SCRIPT_FILE</span><span>=$</span><span style="color:#a3be8c;">(</span><span style="color:#bf616a;">mktemp</span><span style="color:#a3be8c;"> /tmp/lldb_script.XXXXX)</span><span style="color:#96b5b4;">echo </span><span>&quot;</span><span style="color:#a3be8c;">attach </span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">APP_PID</span><span style="color:#a3be8c;">}</span><span>&quot; &gt;&gt; ${</span><span style="color:#bf616a;">LLDB_SCRIPT_FILE</span><span>}echo &quot;</span><span style="color:#a3be8c;">continue</span><span>&quot; &gt;&gt; ${</span><span style="color:#bf616a;">LLDB_SCRIPT_FILE</span><span>}echo &quot;</span><span style="color:#a3be8c;">quit</span><span>&quot; &gt;&gt; ${</span><span style="color:#bf616a;">LLDB_SCRIPT_FILE</span><span>}LLDB_OUT_FILE=$(</span><span style="color:#bf616a;">mktemp</span><span> /tmp/lldb_script.XXXXX)lldb -s ${</span><span style="color:#bf616a;">LLDB_SCRIPT_FILE</span><span>} &gt; ${</span><span style="color:#bf616a;">LLDB_OUT_FILE</span><span>}
</span></code></pre>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#65737e;"># This is the stdout LLDB:## (lldb) command source -s 0 &#39;/tmp/lldb.xijJI&#39;# Executing commands in &#39;/tmp/lldb.xijJI&#39;.# (lldb) attach  89772# Process 89772 stopped# * thread #1, stop reason = signal SIGSTOP#     frame #0: 0x0000000102b00a40 dyld`_dyld_start# dyld`:# -&gt;  0x102b00a40 &lt;+0&gt;:  mov    x0, sp#     0x102b00a44 &lt;+4&gt;:  and    sp, x0, #0xfffffffffffffff0#     0x102b00a48 &lt;+8&gt;:  mov    x29, #0x0#     0x102b00a4c &lt;+12&gt;: mov    x30, #0x0# Target 0: (test_runner-8652616abdef98d9) stopped.# Executable module set to &quot;THE PATH TO THE IOS BUNDLED APP IN THE APP&quot;.# Architecture set to: arm64e-apple-ios-simulator.# (lldb) continue# Process 89772 resuming# Process 89772 exited with status = 0 (0x00000000)# (lldb) quit# Parse the output of lldb to retrieve the status code.
</span></code></pre>
<pre data-lang="sh" style="background-color:#2b303b;color:#c0c5ce;" class="language-sh "><code class="language-sh" data-lang="sh"><span style="color:#bf616a;">STATUS_CODE</span><span>=$</span><span style="color:#a3be8c;">(</span><span style="color:#96b5b4;">\    </span><span style="color:#bf616a;">cat </span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">LLDB_OUT_FILE</span><span style="color:#a3be8c;">} </span><span>| </span><span style="color:#96b5b4;">\    </span><span style="color:#bf616a;">grep </span><span>&quot;</span><span style="color:#a3be8c;">Process \d\+ exited with status = \d\+</span><span>&quot; | </span><span style="color:#96b5b4;">\    </span><span style="color:#bf616a;">grep </span><span>$</span><span style="color:#a3be8c;">{</span><span style="color:#bf616a;">APP_PID</span><span style="color:#a3be8c;">} </span><span>| </span><span style="color:#96b5b4;">\    </span><span style="color:#bf616a;">grep -o </span><span>&quot;</span><span style="color:#a3be8c;">= \d\+</span><span>&quot; | </span><span style="color:#96b5b4;">\    </span><span style="color:#bf616a;">sed </span><span>&#39;</span><span style="color:#a3be8c;">s/= //g</span><span>&#39;</span><span style="color:#96b5b4;">\</span><span style="color:#a3be8c;">)</span><span style="color:#bf616a;">cat </span><span>${</span><span style="color:#bf616a;">APP_STDOUT</span><span>}cat ${</span><span style="color:#bf616a;">APP_STDERR</span><span>} &gt;&amp;</span><span style="color:#d08770;">2</span><span>exit ${</span><span style="color:#bf616a;">STATUS_CODE</span><span>}
</span></code></pre>
<p>Here we:</p>
<ul>
<li>create a very simple <a href="https://lldb.llvm.org/man/lldb.html#cmdoption-lldb-source"><code>lldb</code> script</a></li>
<li>run said lldb script</li>
<li>read the <code>stdout</code>, parse it, and retrieve the exit status.</li>
<li>exit with the status code.</li>
</ul>
<h1 id="future-work">Future Work<a class="zola-anchor" href="#future-work" aria-label="Anchor link for: future-work">ยง</a>
</h1>
<p>In the future I'd like to use
<a href="https://github.com/ios-control/ios-deploy"><code>ios-deploy</code></a> to <a href="https://stackoverflow.com/a/23827549">deploy/run/test
over wifi</a>. The hard part about this is
the requirements and uses of <a href="https://developer.apple.com/library/archive/documentation/Security/Conceptual/CodeSigningGuide/Procedures/Procedures.html"><code>codesign</code>ing the
app</a></p>


        
    

        
        
    </article></div>
    <div class="pagination">
        <div class="pagination__buttons">
            </div>
    </div>
<footer class="footer">
                    <div class="footer__inner"><div class="copyright">
            <span>ยฉ 2025 :: Powered by <a href="https://www.getzola.org/">Zola</a></span>
        </div>
    <script type="text/javascript" src="https://simlay.net/assets/js/main.js"></script>
</div>
                    

                </footer></div>
        <script data-goatcounter="https://simlay.goatcounter.com/count" async src="//gc.zgo.at/count.js"></script><a rel="me" href="https:&#x2F;&#x2F;hachyderm.io&#x2F;@simlay" /></body>
</html>
